<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>妖エルフ・キング</title>
  
  <subtitle>守望初心，简单一点儿。</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.fairysperta.cn/"/>
  <updated>2020-02-06T04:22:49.656Z</updated>
  <id>https://www.fairysperta.cn/</id>
  
  <author>
    <name>妖エルフ・キング</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Redis5单机多节点集群和多机多节点集群以及出现的问题</title>
    <link href="https://www.fairysperta.cn/article/e8c9b678.html"/>
    <id>https://www.fairysperta.cn/article/e8c9b678.html</id>
    <published>2020-02-06T03:31:15.000Z</published>
    <updated>2020-02-06T04:22:49.656Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Feb 06 2020 14:18:23 GMT+0800 (GMT+08:00) --><p>第一步：安装Redis</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis<span class="literal">-5</span>.<span class="number">0.0</span>.tar.gz</span><br><span class="line">tar xzf redis<span class="literal">-5</span>.<span class="number">0.0</span>.tar.gz</span><br><span class="line">cd redis<span class="literal">-5</span>.<span class="number">0.0</span></span><br><span class="line">make</span><br></pre></td></tr></table></figure><p>第二步：修改配置，创建节点<br>我们现在要搞六个节点，三主三从，</p><p>端口规定分别是7001，7002，7003，7004，7005，7006</p><p>我们先在root目录下新建一个redis_cluster目录，然后该目录下再创建6个目录，</p><p>分别是7001，7002，7003，7004，7005，7006，用来存在redis配置文件；</p><p>这里我们要使用redis集群，要先修改redis的配置文件redis.conf</p><p>mkdir redis_cluster 新建目录</p><p>[root@localhost ~]# cd redis_cluster/</p><p>[root@localhost redis_cluster]# mkdir 7001 7002 7003 7004 7005 7006</p><p>先复制一份配置文件到7001目录下</p><p>[root@localhost redis_cluster]# cd</p><p>[root@localhost ~]# cp redis-5.0.0/redis.conf redis_cluster/7001/</p><p>我们修改下这个配置文件</p><p>vi redis_cluster/7001/redis.conf</p><p>修改一下几个</p><p>port 7001 //六个节点配置文件分别是7001-7006</p><p>daemonize yes //redis后台运行</p><p>pidfile /var/run/redis_7001.pid //pidfile文件对应7001-7006</p><p>cluster-enabled yes //开启集群</p><p>cluster-config-file nodes_7001.conf //保存节点配置，自动创建，自动更新对应7001-7006</p><p>cluster-node-timeout 5000 //集群超时时间，节点超过这个时间没反应就断定是宕机</p><p>appendonly yes //存储方式，aof，将写操作记录保存到日志中。<br>//下面可以不写<br>#若设置密码，master和slave需同时配置下面两个参数：<br>masterauth “sfsxxx” #连接master的密码<br>requirepass “jadsfx” #自己的密码<br>大体配置例如</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">port <span class="number">7001</span> <span class="comment">#端口</span></span><br><span class="line">cluster<span class="literal">-enabled</span> yes <span class="comment">#启用集群模式</span></span><br><span class="line">cluster<span class="literal">-config</span><span class="operator">-file</span> nodes_7001.conf ＃集群的配置 配置文件首次启动自动生成</span><br><span class="line">cluster<span class="literal">-node</span><span class="literal">-timeout</span> <span class="number">5000</span> <span class="comment">#超时时间 5秒</span></span><br><span class="line">appendonly yes ＃aof日志开启 它会每次写操作都记录一条日志</span><br><span class="line">daemonize yes <span class="comment">#后台运行</span></span><br><span class="line">protected<span class="literal">-mode</span> no <span class="comment">#非保护模式</span></span><br><span class="line">pidfile  /var/run/redis_7001.pid</span><br></pre></td></tr></table></figure><p>7001下的修改完后，我们把7001下的配置分别复制到7002-7006 然后对应的再修改下配置即可；</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># cp redis_cluster/7001/redis.conf redis_cluster/7002/</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># cp redis_cluster/7001/redis.conf redis_cluster/7003/</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># cp redis_cluster/7001/redis.conf redis_cluster/7004/</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># cp redis_cluster/7001/redis.conf redis_cluster/7005/</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># cp redis_cluster/7001/redis.conf redis_cluster/7006/</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># vi redis_cluster/7002/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># vi redis_cluster/7003/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># vi redis_cluster/7004/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># vi redis_cluster/7005/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># vi redis_cluster/7006/redis.conf</span></span><br></pre></td></tr></table></figure><p>编辑后面5个配置文件，把 port ，pidfile，cluster-config-file 分别修改下即可；</p><p>第三步：启动六个节点的redis</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># /usr/local/redis/bin/redis-server redis_cluster/7001/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># /usr/local/redis/bin/redis-server redis_cluster/7002/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># /usr/local/redis/bin/redis-server redis_cluster/7003/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># /usr/local/redis/bin/redis-server redis_cluster/7004/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># /usr/local/redis/bin/redis-server redis_cluster/7005/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># /usr/local/redis/bin/redis-server redis_cluster/7006/redis.conf</span></span><br></pre></td></tr></table></figure><p>启动六个节点</p><p>[root@localhost ~]# ps -ef | grep redis</p><p>查找下redis进程</p><p>第四步：创建集群</p><p>redis官方提供了redis-trib.rb工具，第一步里已经房到里bin下 ；</p><p>但是在使用之前 需要安装ruby，以及redis和ruby连接</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="literal">-y</span> install ruby ruby<span class="literal">-devel</span> rubygems rpm<span class="literal">-build</span></span><br><span class="line">gem install redis</span><br><span class="line"></span><br><span class="line">redis<span class="literal">-trib</span>.rb create -<span class="literal">-replicas</span> <span class="number">1</span>  <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7001</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7002</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7003</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7004</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7005</span> （redis3.<span class="number">0</span>版本用这个）</span><br><span class="line">redis<span class="literal">-cli</span> -<span class="literal">-cluster</span> create <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7000</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7001</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7002</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7003</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7004</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7005</span>  -<span class="literal">-cluster</span><span class="literal">-replicas</span> <span class="number">1</span>（redis5.<span class="number">0</span>版本）</span><br></pre></td></tr></table></figure><p>效果如下：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Creating cluster</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Performing hash slots allocation on <span class="number">6</span> nodes...</span><br><span class="line"></span><br><span class="line"><span class="keyword">Using</span> 3 masters:</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7001</span></span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7002</span></span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7003</span></span><br><span class="line"></span><br><span class="line">Adding replica <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7004</span> to <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7001</span></span><br><span class="line"></span><br><span class="line">Adding replica <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7005</span> to <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7002</span></span><br><span class="line"></span><br><span class="line">Adding replica <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7006</span> to <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7003</span></span><br><span class="line"></span><br><span class="line">M: bfcfcdc304b011023fa568e044ea23ea6bc03c3c <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7001</span></span><br><span class="line"></span><br><span class="line">   slots:<span class="number">0</span><span class="literal">-5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line"></span><br><span class="line">M: d61e66e49e669b99d801f22f6461172696fdd1c9 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7002</span></span><br><span class="line"></span><br><span class="line">   slots:<span class="number">5461</span><span class="literal">-10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line"></span><br><span class="line">M: aa6bc3f1e1174c3a991c01882584707c2408ec18 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7003</span></span><br><span class="line"></span><br><span class="line">   slots:<span class="number">10923</span><span class="literal">-16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line"></span><br><span class="line">S: <span class="number">7908</span>a60306333c5d7c7c5e7ffef44bdf947ef0a4 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7004</span></span><br><span class="line"></span><br><span class="line">   replicates bfcfcdc304b011023fa568e044ea23ea6bc03c3c</span><br><span class="line"></span><br><span class="line">S: <span class="number">1</span>d2341fd3b79ef0fccb8e3a052bba141337c6cdd <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7005</span></span><br><span class="line"></span><br><span class="line">   replicates d61e66e49e669b99d801f22f6461172696fdd1c9</span><br><span class="line"></span><br><span class="line">S: f25b35f208dc96605ee4660994d2ac52f39ac870 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7006</span></span><br><span class="line"></span><br><span class="line">   replicates aa6bc3f1e1174c3a991c01882584707c2408ec18</span><br><span class="line"></span><br><span class="line">Can I set the above configuration? (type <span class="string">'yes'</span> to accept):</span><br></pre></td></tr></table></figure><p>从运行结果看 主节点就是7001 7002 7003 从节点分别是7004 7005 7006</p><p>7001分配到的哈希槽是 0-5460</p><p>7002分配到的哈希槽是 5461-10922</p><p>7003分配到的哈希槽是 10923-16383</p><p>最后问我们是否接受上面的设置，输入yes 就表示接受，我们输入yes</p><p>然后显示：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line"></span><br><span class="line">Waiting <span class="keyword">for</span> the cluster to join......</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (<span class="keyword">using</span> node 127.0.0.1:7001)</span><br><span class="line"></span><br><span class="line">M: bfcfcdc304b011023fa568e044ea23ea6bc03c3c <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7001</span></span><br><span class="line"></span><br><span class="line">   slots:<span class="number">0</span><span class="literal">-5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line"></span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line"></span><br><span class="line">S: f25b35f208dc96605ee4660994d2ac52f39ac870 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7006</span></span><br><span class="line"></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line"></span><br><span class="line">   replicates aa6bc3f1e1174c3a991c01882584707c2408ec18</span><br><span class="line"></span><br><span class="line">M: d61e66e49e669b99d801f22f6461172696fdd1c9 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7002</span></span><br><span class="line"></span><br><span class="line">   slots:<span class="number">5461</span><span class="literal">-10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line"></span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line"></span><br><span class="line">S: <span class="number">1</span>d2341fd3b79ef0fccb8e3a052bba141337c6cdd <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7005</span></span><br><span class="line"></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line"></span><br><span class="line">   replicates d61e66e49e669b99d801f22f6461172696fdd1c9</span><br><span class="line"></span><br><span class="line">M: aa6bc3f1e1174c3a991c01882584707c2408ec18 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7003</span></span><br><span class="line"></span><br><span class="line">   slots:<span class="number">10923</span><span class="literal">-16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line"></span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line"></span><br><span class="line">S: <span class="number">7908</span>a60306333c5d7c7c5e7ffef44bdf947ef0a4 <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">7004</span></span><br><span class="line"></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line"></span><br><span class="line">   replicates bfcfcdc304b011023fa568e044ea23ea6bc03c3c</span><br><span class="line"></span><br><span class="line">[<span class="type">OK</span>] All nodes agree about slots configuration.</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line"></span><br><span class="line">[<span class="type">OK</span>] All <span class="number">16384</span> slots covered.</span><br></pre></td></tr></table></figure><p>显示配置哈希槽，以及集群创建成功，可以用了；<br>若出现如下错误：<br>[ERR] Node 127.0.0.1:7001 is not empty. Either the nodealready knows other nodes (check with CLUSTER NODES) or contains some key in database 0.<br>解决办法如下：<br>1)、将需要新增的节点下aof、rdb等本地备份文件删除；</p><p>2)、同时将新Node的集群配置文件删除,即：删除你redis.conf里面cluster-config-file所在的文件；</p><p>3)、再次添加新节点如果还是报错，则登录新Node,./redis-cli–h x –p对数据库进行清除：</p><p>127.0.0.1:7001&gt; flushdb #清空当前数据库<br>若出现[ERR] Not all 16384 slots are covered by nodes.的错误<br>解决办法如下：<br>redis-trib.rb fix 127.0.0.1:7001（3.0版本）<br>redis-trib.rb check 127.0.0.1:7000（3.0版本）<br>redis-cli –cluster fix 127.0.0.1:7001（5.0版本）<br>redis-cli –cluster check 127.0.0.1:7001（5.0版本）<br>只要输入任意集群中节点即可，会自动检查所有相关节点。可以查看相应的输出看下是否是每个Master都有了slots,如果分布不均匀那可以使用下面的方式重新分配。</p><p>多节点集群搭建<br>一、环境搭建<br>同一局域网下创建两台虚拟机或者其他机器在局域网下。</p><p>第二步：修改配置，创建节点</p><p>首先我们在192.168.0.5虚拟机里创建三个节点，端口分别是7001，7002，7003</p><p>我们先在root目录下新建一个redis_cluster目录，然后该目录下再创建3个目录，</p><p>分别是7001，7002，7003，用来存redis配置文件；</p><p>这里我们要使用redis集群，要先修改redis的配置文件redis.conf</p><p>mkdir redis_cluster 新建目录</p><p>[root@localhost ~]# cd redis_cluster/</p><p>[root@localhost redis_cluster]# mkdir 7001 7002 7003</p><p>先复制一份配置文件到7001目录下</p><p>[root@localhost redis_cluster]# cd</p><p>[root@localhost ~]# cp redis-5.5.0/redis.conf redis_cluster/7001/</p><p>我们修改下这个配置文件</p><p>vi redis_cluster/7001/redis.conf</p><p>修改一下几个</p><p>port 7001 //六个节点配置文件分别是7001-7003</p><p>bind 192.168.0.5 //默认ip为127.0.0.1 需要改为其他节点机器可访问的ip 否则创建集群时无法访，和单机集群有区别</p><p>daemonize yes //redis后台运行</p><p>pidfile /var/run/redis_7001.pid //pidfile文件对应7001-7003</p><p>cluster-enabled yes //开启集群</p><p>cluster-config-file nodes_7001.conf //保存节点配置，自动创建，自动更新对应7001-7003</p><p>cluster-node-timeout 5000 //集群超时时间，节点超过这个时间没反应就断定是宕机</p><p>appendonly yes //存储方式，aof，将写操作记录保存到日志中</p><p>7001下的修改完后，我们把7001下的配置分别复制到7002-7003 然后对应的再修改下配置即可；</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># cp redis_cluster/7001/redis.conf redis_cluster/7002/</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># cp redis_cluster/7001/redis.conf redis_cluster/7003/</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># vi redis_cluster/7002/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># vi redis_cluster/7003/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># vi redis_cluster/7004/redis.conf</span></span><br></pre></td></tr></table></figure><p>编辑后面5个配置文件，把 port ，pidfile，cluster-config-file 分别修改下即可；<br>同理 192.168.0.6机器，也搞一个redis_cluster目录，然后再新建7004，7005，7006目录，<br>第三步：启动两台机器的六个节点<br>启动之前先检查appendonly.aof和dump.rdp以及node-7001-7006的conf文件是否删除，避免出现问题<br>192.168.0.5机器</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># /usr/local/redis/bin/redis-server redis_cluster/7001/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># /usr/local/redis/bin/redis-server redis_cluster/7002/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># /usr/local/redis/bin/redis-server redis_cluster/7003/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># ps -ef | grep redis  </span></span><br><span class="line"></span><br><span class="line">root       <span class="number">2242</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">19</span>:<span class="number">55</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /usr/local/redis/bin/redis<span class="literal">-server</span> <span class="number">192.168</span>.<span class="number">0.5</span>:<span class="number">7001</span> [<span class="type">cluster</span>]</span><br><span class="line"></span><br><span class="line">root       <span class="number">2252</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">19</span>:<span class="number">59</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /usr/local/redis/bin/redis<span class="literal">-server</span> <span class="number">192.168</span>.<span class="number">0.5</span>:<span class="number">7002</span> [<span class="type">cluster</span>]</span><br><span class="line"></span><br><span class="line">root       <span class="number">2256</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">19</span>:<span class="number">59</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /usr/local/redis/bin/redis<span class="literal">-server</span> <span class="number">192.168</span>.<span class="number">0.5</span>:<span class="number">7003</span> [<span class="type">cluster</span>]</span><br><span class="line"></span><br><span class="line">root       <span class="number">2260</span>   <span class="number">2214</span>  <span class="number">0</span> <span class="number">19</span>:<span class="number">59</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep -<span class="literal">-color</span>=auto redis</span><br></pre></td></tr></table></figure><p>192.168.0.6机器</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># /usr/local/redis/bin/redis-server redis_cluster/7004/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># /usr/local/redis/bin/redis-server redis_cluster/7005/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># /usr/local/redis/bin/redis-server redis_cluster/7006/redis.conf </span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># ps -ef | grep redis  </span></span><br><span class="line"></span><br><span class="line">root       <span class="number">2347</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">20</span>:<span class="number">31</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /usr/local/redis/bin/redis<span class="literal">-server</span> <span class="number">192.168</span>.<span class="number">0.6</span>:<span class="number">7004</span> [<span class="type">cluster</span>]</span><br><span class="line"></span><br><span class="line">root       <span class="number">2351</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">20</span>:<span class="number">31</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /usr/local/redis/bin/redis<span class="literal">-server</span> <span class="number">192.168</span>.<span class="number">0.6</span>:<span class="number">7005</span> [<span class="type">cluster</span>]</span><br><span class="line"></span><br><span class="line">root       <span class="number">2355</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">20</span>:<span class="number">31</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /usr/local/redis/bin/redis<span class="literal">-server</span> <span class="number">192.168</span>.<span class="number">0.6</span>:<span class="number">7006</span> [<span class="type">cluster</span>]</span><br><span class="line"></span><br><span class="line">root       <span class="number">2363</span>   <span class="number">2270</span>  <span class="number">0</span> <span class="number">20</span>:<span class="number">32</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep -<span class="literal">-color</span>=auto redis</span><br></pre></td></tr></table></figure><p>说明都启动OK<br>第四步：设置防火墙，开放集群端口</p><p>两台机器的防火墙我们直接关掉</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br></pre></td></tr></table></figure><p>第五步：创建集群</p><p>192.168.0.5机器作为集群控制端</p><p>redis官方提供了redis-trib.rb工具，第一步里已经房到里bin下 ；</p><p>但是在使用之前 需要安装ruby，以及redis和ruby连接</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="literal">-y</span> install ruby ruby<span class="literal">-devel</span> rubygems rpm<span class="literal">-build</span></span><br><span class="line"></span><br><span class="line">gem install redis</span><br></pre></td></tr></table></figure><p>开始在05机器创建</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis<span class="literal">-cli</span> -<span class="literal">-cluster</span> create  <span class="number">192.168</span>.<span class="number">0.5</span>:<span class="number">7001</span> <span class="number">192.168</span>.<span class="number">0.5</span>:<span class="number">7002</span> <span class="number">192.168</span>.<span class="number">0.5</span>:<span class="number">7003</span> <span class="number">192.168</span>.<span class="number">0.6</span>:<span class="number">7004</span> <span class="number">192.168</span>.<span class="number">0.6</span>:<span class="number">7005</span> <span class="number">192.168</span>.<span class="number">0.6</span>:<span class="number">7006</span> -<span class="literal">-cluster</span><span class="literal">-replicas</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p><img src="/images/pasted-3.png" alt="upload successful"><br>从运行结果看 主节点就是7001 7004 7002 从节点分别是7005 7003 7006</p><p>7001分配到的哈希槽是 0-5460</p><p>7004分配到的哈希槽是 5461-10922</p><p>7002分配到的哈希槽是 10923-16383</p><p>最后问我们是否接受上面的设置，输入yes 就表示接受，我们输入yes<br>然后显示：<br><img src="/images/pasted-4.png" alt="upload successful"><br>显示配置哈希槽，以及集群创建成功，可以用了；</p><p>第六步：集群数据测试</p><p>我们先连接任意一个节点，然后添加一个key：</p><p>redis-cli是redis默认的客户端工具，启动时加上｀-c｀参数，<code>-p</code>指定端口，就可以连接到集群。</p><p>这里还得加-h 指定机器IP</p><p>连接任意一个节点端口：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">localhost</span> ~]<span class="comment"># /usr/local/redis/bin/redis-cli -h 192.168.0.5 -c -p 7002</span></span><br></pre></td></tr></table></figure><p>192.168.0.5:7002&gt;</p><p>连接到7002节点</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168</span>.<span class="number">1.5</span>:<span class="number">7002</span>&gt; set xxx <span class="string">'fadfa'</span></span><br><span class="line"></span><br><span class="line">-&gt; Redirected to slot [<span class="number">4038</span>] located at <span class="number">192.168</span>.<span class="number">0.5</span>:<span class="number">7001</span></span><br><span class="line"></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>前面说过Redis Cluster值分配规则，所以分配key的时候，它会使用CRC16(‘my_name’)%16384算法，来计算，将这个key 放到哪个节点，这里分配到了4038slot 就分配到了7001(0-5460)这个节点上。所以有：</p><p>Redirected to slot [4038] located at 192.168.0.5:7001</p><p>我们从其他集群节点 ，都可以获取到数据</p><p>[root@localhost ~]# /usr/local/redis/bin/redis-cli -h 192.168.0.6 -c -p 7005</p><p>192.168.0.6:7005&gt;</p><p>192.168.0.6:7005&gt; get xxx</p><p>-&gt; Redirected to slot [4038] located at 192.168.0.5:7001</p><p>“fadfa”</p><p>192.168.0.5:7001&gt;</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Thu Feb 06 2020 14:18:23 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;第一步：安装Redis&lt;/p&gt;&lt;figure class=&quot;highlight powershell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class
      
    
    </summary>
    
    
    
      <category term="redis" scheme="https://www.fairysperta.cn/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="https://www.fairysperta.cn/article/4a17b156.html"/>
    <id>https://www.fairysperta.cn/article/4a17b156.html</id>
    <published>2020-01-30T15:54:24.000Z</published>
    <updated>2020-01-31T08:18:24.852Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Feb 06 2020 14:18:22 GMT+0800 (GMT+08:00) --><p>Hello World</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><p><img src="/images/pasted-2.png" alt="upload successful"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Thu Feb 06 2020 14:18:22 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Hello World&lt;/p&gt;&lt;h2 id=&quot;Quick-Start&quot;&gt;&lt;a href=&quot;#Quick-Start&quot; class=&quot;header
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>IntelliJ IDEA 2019.3.2完美破解</title>
    <link href="https://www.fairysperta.cn/article/b422190f.html"/>
    <id>https://www.fairysperta.cn/article/b422190f.html</id>
    <published>2020-01-30T14:14:00.000Z</published>
    <updated>2020-02-06T04:26:24.460Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Thu Feb 06 2020 14:18:22 GMT+0800 (GMT+08:00) --><p>1、下载IDEA 链接：</p><p><a href="https://pan.baidu.com/s/16uV6pZzk-D5ynGDIoatQ8A" target="_blank" rel="noopener">https://pan.baidu.com/s/16uV6pZzk-D5ynGDIoatQ8A</a></p><p>提取码：p0ve</p><p>下载破解所需jetbrains-agent.jar:<br><a href="https://pan.baidu.com/s/1E4MPqD3pDexZY93JDBcftQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1E4MPqD3pDexZY93JDBcftQ</a></p><p>提取码：xx19<br>2、安装完毕后，将破解文件“jetbrains-gent.jar”<br>和“important.txt”拷贝至idea安装目录的bin下，然后启动你的IDE，<br>如果上来就需要注册，选择：试用（Evaluate for free）进入IDE<br>3、点击你要注册的IDE菜单：<br>“Configure” 或 “Help” -&gt; “Edit Custom VM Options …” 如果提示是否要创建文件，请点”Yes”。</p><p>参考文章：<a href="https://intellij-support.jetbrains.com/hc/en-us/articles/206544869" target="_blank" rel="noopener">https://intellij-support.jetbrains.com/hc/en-us/articles/206544869</a></p><p>4、打开vmoptions编辑窗口后<br>-javaagent:/absolute/path/to/jetbrains-agent.jar。<br>一定要自己确认好路径(不要使用中文路径)，填错会导致IDE打不开！！！!<br><img src="/images/pasted-0.png" alt="upload successful"></p><p>注意事项：</p><p>一个vmoptions内只能有一个-javaagent参数。</p><pre><code>示例:  mac:      -javaagent:/Users/neo/jetbrains-agent.jar  linux:    -javaagent:/home/neo/jetbrains-agent.jar  windows:  -javaagent:C:\Users\neo\jetbrains-agent.jar如果还是填错了，参考这篇文章编辑vmoptions补救：[https://intellij-support.jetbrains.com/hc/en-us/articles/206544519](https://intellij-support.jetbrains.com/hc/en-us/articles/206544519)</code></pre><p>5、重启IDE，点击IDE菜单 “Help” -&gt; “Register…” 或 “Configure” -&gt; “Manage License…”</p><p>支持两种注册方式：License server 和 Activation code:</p><pre><code>1). 选择License server方式，地址填入：http://jetbrains-license-server 或者点击按钮：&quot;Discover Server&quot;来自动填充地址。网络不佳的见第2种方式。2). 选择Activation code方式离线激活，请使用：下载好的jetbrains-agent.rar中ACTIVATION_CODE.txt 内的注册码激活    如果激活窗口一直弹出（error 1653219），请去hosts文件里移除jetbrains相关的项目    License key is in legacy format == Key invalid，表示agent配置未生效。</code></pre><p>6、激活成功效果如下:</p><p><img src="/images/pasted-1.png" alt="upload successful"></p><p>参考：<a href="https://zhile.io/2018/08/17/jetbrains-license-server-crack.html" target="_blank" rel="noopener">https://zhile.io/2018/08/17/jetbrains-license-server-crack.html</a><br><a href="https://github.com/jmzhoulab/develop-tools/blob/master/idea/crack.md" target="_blank" rel="noopener">https://github.com/jmzhoulab/develop-tools/blob/master/idea/crack.md</a></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Thu Feb 06 2020 14:18:22 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;1、下载IDEA 链接：&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://pan.baidu.com/s/16uV6pZzk-D5ynGDIoat
      
    
    </summary>
    
    
    
      <category term="intellijidea" scheme="https://www.fairysperta.cn/tags/intellijidea/"/>
    
  </entry>
  
</feed>
